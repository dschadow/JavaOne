<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:camel="http://camel.apache.org/schema/spring"
	xmlns:jdbc="http://www.springframework.org/schema/jdbc"
	xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd
       http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc-3.0.xsd">
	<import resource="classpath:spring/services.cxf.xml" />

	<bean id="employees" class="de.bit.camel.security.beans.EmployeeBean" />
	
	<bean id="accounting" class="de.bit.camel.security.beans.AccountingBean" />

	<camelContext id="camel" xmlns="http://camel.apache.org/schema/spring">
		<!-- call this web service with an employee ID value 10001 (manager), 10002 or 10003 -->
		<route id="empInfoEndpoint">
			<from uri="cxf:bean:empInfoEndpoint" />
			<log message="empInfoEndpoint started with body ${body}" />
			<log message="empInfoEndpoint called with operation: ${in.header.operationName}" />
			
			<!-- body always consists of an Integer employee ID only -->
			<convertBodyTo type="java.lang.Integer" />
			
			<choice>
				<when>
					<simple>${in.header.operationName} == 'getEmployeeInformation'</simple>
					<to uri="direct:hr" />
			
					<choice>
						<when>
			                <xpath>/employee/jobTitle = 'Manager'</xpath>
							<to uri="direct:sac" />
						</when>
						<otherwise>
							<to uri="direct:ac" />
						</otherwise>
				    </choice>
				</when>
				<otherwise>
					<log message="Unknown operation name ${in.header.operationName}" loggingLevel="ERROR"/>
				</otherwise>
			</choice>
			
			<log message="empInfoEndpoint finished with body ${body}" />
		</route>	
		
		<route id="hr">
			<from uri="direct:hr" />
			<log message="hr started with body ${body}" />
			
			<bean ref="employees" method="getEmployeeData" />
			
			<log message="hr finished with body ${body}" />
		</route>

		<route id="ac">
			<from uri="direct:ac" />
			<log message="ac started with body ${body}" />
			
			<bean ref="accounting" method="getSalaryForEmployee" />
			
			<log message="ac finished with body ${body}" />
		</route>

		<route id="sac">
			<from uri="direct:sac" />
			<log message="sac started with body ${body}" />
			
			<bean ref="accounting" method="getSalaryForEmployee" />
			<bean ref="accounting" method="getTotalSalaryForManager" />
			
			<log message="sac finished with body ${body}" />
		</route>
	</camelContext>

	<jdbc:embedded-database id="dataSource">
		<jdbc:script location="classpath:schema.sql" />
		<jdbc:script location="classpath:data.sql" />
	</jdbc:embedded-database>
</beans>